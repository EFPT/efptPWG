---
title: "Demographics plots"
author: "Roberts Klotins and Thomas Gargot"
date: "6th March 2016"
output: html_document
css: simple.css
---

This piece of markdown explores how to do markdown reports using `ggplot` graphs, displaying textual data in tables using `kable`, and naming rmarkdown chunks so that they can be referred to from other chunks.

```{r setup, echo=FALSE, message=FALSE}
# set variables that in main analysis may be auto-generated
# i.e. on every iteration replaced from list
country <- "Czech Republic"
# prepare for plots - get libraries and paths right
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(knitr)
library(RColorBrewer)
library(gridExtra)
# paths - get data and change back
curDir <- getwd()
setwd("~/src/efptPWG/data/Belgium")
source("./Belgium_R_syntax_file.R")
setwd <- curDir
# print("This was chunk 1")
```


```{r ggFunctions, echo = FALSE}
# functions
# PIE charts in ggplot
ggpie <- function (dat, by, totals, plotTitle) {
  ggplot(dat, aes_string(x=factor(1), y=totals, fill=by)) +
    geom_bar(stat='identity', color='black', width=1) +
    guides(fill=guide_legend(override.aes=list(colour=NA))) + 
    coord_polar(theta='y') +
    ggtitle(plotTitle) +
    theme(axis.ticks=element_blank(),
          axis.text.y=element_blank(),
          axis.text.x=element_text(colour='black'),
          axis.title=element_blank()) +
    scale_y_continuous(breaks=cumsum(dat[[totals]]) - dat[[totals]] / 2, labels=dat[[by]])
}

# print('This WAS chunk 2')
```

### Demographics of our study population in `r country`

We had `r nrow(data)` of responses from `r country`


```{r demographics, results='markup', echo=FALSE ,warning= FALSE, message=FALSE}

# small intermediate data frame to pass to ggpie function

df.sex <- as.data.frame(table(data$q_0001))
colnames(df.sex) <- c("Sex","Number")
ggp.sex <- ggpie(df.sex,'Sex','Number',"Population by Gender")
#ggp.sex
ggp.sex <- ggp.sex +  scale_fill_brewer(palette="YlGn")
# first plot object has been set up
# print('I am in chunk 3')

kable(df.sex,'markdown')
# table width 40% is set via css referred to in YAML header


# plot histogram of age distribution with binwidth 1
gb.age <- ggplot(data, aes(q_0002, fill=..count..)) +geom_histogram(color="white")
gb.age <- gb.age +ggtitle("Age distribution")  +
  scale_fill_continuous(trans = 'reverse', guide = guide_legend(title = "Nr.")) +
  xlab("Age distribution") + ylab("Count of respondents")
# gb.age histogram ready

# print plots side by side
grid.arrange(ggp.sex,gb.age,nrow=1)
```

This is the first go at ggplot graphics and we can see it work in HTML and PDF. 
